<!DOCTYPE html>
<style>
path.link {
  fill: none;
  stroke: #CCC;
  stroke-width: 1.5px;
}

circle {
  stroke: #CCC;
  stroke-width: 1.5px;
}
/*
If the node is nonzero, all outgoing edges should be highlighted
*/
marker {
  fill: none;
  stroke: #CCC;
}
</style>
<meta charset="utf-8">
<div id="canvas-svg"></div>
<div id="controlContainer">
  <div id="play_control">
    <span id="iterations_slider_container"></span>
  </div>
  <div id="play_control_bottom">
    <span id="buttons">
      <i id="start-button" class="fa fa-play" style="display: inline"></i>
      <i id="pause-button" class="fa fa-pause" style="display: none"></i>
      <i id="reset-button" class="fa fa-step-backward"></i>
    </span>
    <span id="iterations_display"></span>
  </div>
</div>
<script src="http://d3js.org/d3.v3.min.js"></script>
<link rel="stylesheet" href="twitter.css"/>
<link rel="stylesheet" href="test.css"/>
<link href="//netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css" rel="stylesheet">
<script >
var WIDTH = 2550, HEIGHT = 1350;
var width = WIDTH, height = HEIGHT;
var svg = d3.select("#canvas-svg").append("svg").attr("width", width).attr("height", height);
var color = d3.scale.linear().domain([0, .005]).range(['white', 'red']);
var slider = d3.select("#slider").attr("width", 1000);
var graph;

var drawD3Document = function(links) {
    var nodes = {};
    links.forEach(function(link) {
        link.source = nodes[link.source] || (nodes[link.source] = {
            name: link.source
        });
        link.target = nodes[link.target] || (nodes[link.target] = {
            name: link.target
        });
        link.value = +link.value;
    });
    var force = d3.layout.force().nodes(d3.values(nodes)).links(links).size([ width, height ]).linkDistance(5).charge(-100).on("tick", tick);
    svg.append("svg:defs").selectAll("marker").data([ "end" ]).enter().append("svg:marker").attr("id", String).attr("viewBox", "0 -5 10 10").attr("refX", 15).attr("refY", -1.5).attr("markerWidth", 6).attr("markerHeight", 6).attr("orient", "auto").append("svg:path").attr("d", "M0,-5L10,0L0,5");
    var path = svg.append("svg:g").selectAll("path").data(force.links()).enter().append("svg:path").attr("class", "link").attr("marker-end", "url(#end)");
    var node = svg.selectAll(".node").data(force.nodes()).enter().append("g").attr("class", "node");
    node.append("circle").attr("r", 5);
    force.start();
    for (var i = 0; i < 100; ++i) force.tick();
    force.stop();
    function tick() {
        path.attr("d", function(d) {
            var dx = d.target.x - d.source.x, dy = d.target.y - d.source.y, dr = Math.sqrt(dx * dx + dy * dy);
            return "M" + d.source.x + "," + d.source.y + "A" + dr + "," + dr + " 0 0,1 " + d.target.x + "," + d.target.y;
        });
        node.attr("transform", function(d) {
            return "translate(" + d.x + "," + d.y + ")";
        });
    }
};
  
d3.json("data/cambridge_twitter_graph.json", function(error, graph){
  drawD3Document(graph.links);
  svg.selectAll("circle").attr('fill', function(d) { return color(graph.pagerank["0"][d.name])});
  //var slider = d3.select('#slider').call(d3.slider().axis(true).min(0).max(100).step(1).on("slide", on_slide));
  var iterations_index = 0;

  function updateGraph(iterations_index) {
    iterations = Object.keys(graph.pagerank)[iterations_index];
    console.log(iterations);
    svg.selectAll("circle").transition().attr('fill', function(d) { return color(graph.pagerank[iterations][d.name])});
    d3.select("#iterations_slider").property("value", iterations_index);
    d3.select("body").selectAll("#iterations_display").transition().text(iterations);
  }

  function drawSlider() {
    iterationsdisplay = d3.select("body").selectAll("#iterations_display");
    start_button = d3.select("#start-button").on('click', startRun);
    iterations_slider = d3.select("body").select("#iterations_slider_container").append("input")
     .attr("type", "range")
     .attr("class", "slider")
     .attr("min", 0)
     .attr("max", Object.keys(graph.pagerank).length)
     .property("value", iterations_index)
     .attr("id", "iterations_slider")
   
    iterations_slider.on("change", function() {
      updateGraph(this.value);
      });
    d3.select("#reset-button").on('click', resetOnClick);
  }

  function startRun() {
    if (iterations_index == Object.keys(graph.pagerank).length) {iterations_index = 0;}
    timer_stop = false;
    d3.select("#start-button").style("display", "none");
    pause_button = d3.select("#pause-button")
      .style("display", "inline")
      .on('click', pauseOnClick);
      runThrough();
  }

  function pauseOnClick() {
    timer_stop = true;
    clearInterval(clearVal);
    pause_button = d3.select("#pause-button");
    pause_button.style("display", "none");
    d3.select("#start-button").style("display", "inline");
  }

  function resetOnClick() {
    pauseOnClick();
    updateGraph(0);
  }

  function runThrough() {
    clearVal = setInterval(step, 500);
  }

  function step() {
    if (iterations_index < Object.keys(graph.pagerank).length) {
      iterations_index++;
      updateGraph(iterations_index);
      return timer_stop;
    } else {
      iterations_index = 0;
      updateGraph(iterations_index);
      resetOnClick();
      return true;
    }
  }
  drawSlider();
});


</script>
